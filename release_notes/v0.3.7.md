# PiPinPP v0.3.7 Release Notes

**Release Date:** November 6, 2025  
**Type:** Feature Release (Minor Update)

## üéâ What's New

Version 0.3.7 adds **SPI (Serial Peripheral Interface) communication** with Arduino-inspired API, completes **comprehensive documentation for all 19 examples**, and fixes a critical thread-safety bug in the Wire library. This release represents a major milestone in communication protocol support.

---

## ‚ú® New Features

### SPI Communication Protocol

Full hardware SPI master support with Arduino-inspired API:

#### SPI Class Functions

```cpp
void SPI.begin();
void SPI.end();
uint8_t SPI.transfer(uint8_t value);
void SPI.transfer(void* buf, size_t count);
void SPI.setDataMode(uint8_t mode);
void SPI.setBitOrder(uint8_t bitOrder);
void SPI.setClock(uint32_t clock);
void SPI.setClockDivider(uint8_t divider);
void SPI.setBitOrder(uint8_t bitOrder);
void SPI.beginTransaction(SPISettings settings);
void SPI.endTransaction();
```

**Perfect for:**
- Shift registers (74HC595 for outputs)
- LED matrices and displays
- SD card communication
- Sensor modules (accelerometers, gyroscopes)
- ADC/DAC chips
- Wireless modules (NRF24L01, etc.)

**Features:**
- Hardware SPI via `/dev/spidev0.0` or `/dev/spidev0.1`
- Supports all 4 SPI modes (0-3)
- Configurable clock speed (125 kHz to 125 MHz)
- LSB-first or MSB-first bit order
- Thread-safe with mutex protection
- SPISettings for transaction management
- 2-4x faster than software bit-banging

**SPI Modes:**
```cpp
SPI_MODE0  // CPOL=0, CPHA=0 (sample on rising, setup on falling)
SPI_MODE1  // CPOL=0, CPHA=1 (setup on rising, sample on falling)
SPI_MODE2  // CPOL=1, CPHA=0 (sample on falling, setup on rising)
SPI_MODE3  // CPOL=1, CPHA=1 (setup on falling, sample on rising)
```

**Clock Dividers:**
```cpp
SPI_CLOCK_DIV2    // 62.5 MHz
SPI_CLOCK_DIV4    // 31.25 MHz
SPI_CLOCK_DIV8    // 15.625 MHz
SPI_CLOCK_DIV16   // 7.8125 MHz
SPI_CLOCK_DIV32   // 3.90625 MHz
SPI_CLOCK_DIV64   // 1.953125 MHz
SPI_CLOCK_DIV128  // 976.5625 kHz
```

**Example - Simple Transfer:**
```cpp
#include <SPI.hpp>

SPI.begin();
SPI.setDataMode(SPI_MODE0);
SPI.setClock(1000000);  // 1 MHz

uint8_t data = 0xAB;
uint8_t response = SPI.transfer(data);

SPI.end();
```

**Example - 74HC595 Shift Register:**
```cpp
const int LATCH_PIN = 8;

pinMode(LATCH_PIN, OUTPUT);
SPI.begin();

// Send data pattern
digitalWrite(LATCH_PIN, LOW);
SPI.transfer(0b10101010);  // LED pattern
digitalWrite(LATCH_PIN, HIGH);
```

**Example - Transaction Management:**
```cpp
SPISettings mySettings(1000000, MSBFIRST, SPI_MODE0);

SPI.beginTransaction(mySettings);
digitalWrite(CS_PIN, LOW);
SPI.transfer(0x42);
digitalWrite(CS_PIN, HIGH);
SPI.endTransaction();
```

---

## üìö New Documentation

### New SPI Example

**`examples/spi_74hc595/`** - SPI vs Software Comparison
- Complete 74HC595 shift register control
- Hardware SPI vs `shiftOut()` performance comparison
- Multiple LED patterns (binary counter, chase, wave)
- Benchmarking and timing analysis
- Wiring diagrams and hardware setup
- Demonstrates 2-4x speed improvement

**Build and run:**
```bash
cd build/examples
./example_spi_74hc595
```

### Complete Example Documentation

All 19 examples now have comprehensive README.md files:

1. **basic_led/** - GPIO basics with LED control
2. **button_input/** - Digital input with pull resistors
3. **button_interrupt/** - Hardware interrupts and callbacks
4. **led_fade/** - Software PWM and smooth fading
5. **arduino_style/** - Arduino API compatibility demo
6. **arduino_migration/** - Porting guide from Arduino
7. **exception_handling/** - Error handling patterns
8. **thread_safety/** - Multi-threaded GPIO access
9. **timing_benchmark/** - Performance measurements
10. **advanced_io/** - pulseIn, shiftOut, tone functions
11. **math_functions/** - Extended math operations
12. **trig_functions/** - Trigonometric calculations
13. **utility_functions/** - Bit/byte manipulation
14. **i2c_scanner/** - I2C bus device detection
15. **i2c_bmp280/** - Temperature/pressure sensor
16. **i2c_mpu6050/** - Accelerometer/gyroscope
17. **i2c_ssd1306/** - OLED display control
18. **robot_stress_test/** - Multi-threaded robotics sim
19. **spi_74hc595/** - SPI shift register control (NEW)

**Each README includes:**
- Hardware requirements and wiring diagrams
- Pin connections table
- Build and run instructions
- Expected output examples
- Troubleshooting section
- Extension ideas and challenges

### Updated API Documentation

**`docs/API_REFERENCE.md`** - New Communication Protocols Chapter
- Complete Wire/I¬≤C API reference (15+ functions)
- Complete SPI API reference (11+ functions)
- Function signatures with parameters and returns
- Code examples for each function
- Comparison tables for modes and speeds
- Best practices and usage patterns

---

## üêõ Bug Fixes

### Critical: Wire I2C Mutex Deadlock

**Issue:** `Wire.begin()` calling `Wire.begin(int)` with the same mutex lock caused a deadlock when requesting from I2C devices.

**Symptoms:**
- Hang when calling `Wire.requestFrom()`
- Programs freeze during I2C communication
- No error messages, just infinite wait

**Fix:** Refactored `begin()` to call `_beginInternal(int)` helper instead of `begin(int)`, eliminating recursive mutex locking.

**Impact:** All Wire/I2C examples now work reliably without hangs.

### Constant Definition Conflicts

**Issue:** `MSBFIRST` and `LSBFIRST` defined in both `ArduinoCompat.hpp` and `SPI.hpp` with different values.

**Symptoms:**
- Compilation errors: "conflicts with a previous declaration"
- Undefined behavior with bit order settings

**Fix:** Unified constants in `ArduinoCompat.hpp` (`MSBFIRST=1`, `LSBFIRST=0`), `SPI.hpp` references them.

**Impact:** Clean compilation, consistent behavior across `shiftOut()` and `SPI.transfer()`.

---

## üîß Technical Details

### Implementation Quality

- **All tests passing:** 88/88 (100%)
  - 66 original tests
  - 22 new SPI tests
- **Zero warnings:** Clean build with `-Wall -Wextra -Wpedantic -Werror`
- **Documentation:** Complete Doxygen comments for all APIs
- **Code Quality:** Thread-safe, RAII-compliant, exception-safe
- **Examples:** 19 fully documented examples

### SPI Implementation

- **Backend:** Linux `spidev` driver via `/dev/spidev0.0`
- **Performance:** Up to 125 MHz clock speed
- **Thread Safety:** Internal mutex for concurrent access
- **Error Handling:** Exceptions for initialization failures
- **Resource Management:** RAII cleanup on `end()` or destruction

### Test Coverage

**SPI Tests (22 total):**
- Initialization and configuration
- Single byte transfer
- Buffer transfers
- Mode setting (all 4 modes)
- Clock speed configuration
- Bit order (MSB/LSB first)
- Thread safety validation
- Arduino API compatibility
- Error handling

**Hardware-Aware Testing:**
- Tests skip gracefully without `/dev/spidev*` devices
- `GTEST_SKIP()` used for hardware-dependent tests
- CI builds pass without SPI hardware

---

## üì¶ Installation

### Quick Install (Recommended)

```bash
curl -sSL https://raw.githubusercontent.com/Barbatos6669/PiPinPP/v0.3.7/install.sh | sudo bash
```

### Update from v0.3.6

```bash
cd PiPinPP
git fetch
git checkout v0.3.7
./build.sh
cd build
sudo make install
sudo ldconfig
```

### Verify Installation

```bash
pkg-config --modversion pipinpp  # Should show: 0.3.7
```

### Enable SPI on Raspberry Pi

```bash
sudo raspi-config
# Interface Options ‚Üí SPI ‚Üí Enable
sudo reboot
```

Verify SPI devices:
```bash
ls -l /dev/spidev*
# Should show: /dev/spidev0.0 and /dev/spidev0.1
```

---

## üéØ Use Cases

### Hardware SPI Applications

**Output Expansion:**
- 74HC595 shift registers for controlling many LEDs
- Daisy-chain multiple chips (16, 24, 32+ outputs)
- LED matrices and 7-segment displays

**Display Modules:**
- TFT LCD screens (ILI9341, ST7735)
- E-ink displays
- LED strips (APA102, SK9822)

**Data Acquisition:**
- MCP3008 ADC (8-channel analog input)
- MAX31855 thermocouple amplifier
- Sensor modules with SPI interface

**Communication:**
- NRF24L01+ wireless modules
- SD card readers
- Ethernet modules (W5500)

### Robotics & Automation

- Fast sensor polling with hardware SPI
- Efficient motor driver control
- Status LEDs via shift registers
- Multi-sensor data acquisition

---

## üîÑ Migration from v0.3.6

**Breaking Changes:** None! Pure feature addition.

**Wire Fix:** If you experienced hangs with I2C, upgrade immediately. No code changes needed.

### New Headers

SPI support added to includes:
```cpp
#include <SPI.hpp>        // SPI communication
#include <ArduinoCompat.hpp>  // All other Arduino functions

// Global SPI instance ready to use
SPI.begin();
```

### Constant Updates

`MSBFIRST` and `LSBFIRST` now unified in `ArduinoCompat.hpp`:
```cpp
// Works consistently across shiftOut() and SPI
shiftOut(DATA, CLK, MSBFIRST, 0xFF);
SPI.setBitOrder(MSBFIRST);
```

---

## üìä Statistics

### Code Changes
- **Files changed:** 12
- **Lines added:** 1,400+
- **New SPI functions:** 11
- **New SPI constants:** 11
- **New tests:** 22
- **New examples:** 1
- **Example READMEs created:** 17

### Test Coverage
- **Total tests:** 88 (66 original + 22 SPI)
- **Pass rate:** 100%
- **Test time:** <2 seconds

### Documentation
- **API Reference:** Added Communication Protocols chapter (500+ lines)
- **Example READMEs:** 17 new comprehensive guides
- **SPI example:** 300+ lines with benchmarks
- **Release notes:** This document!

---

## üöÄ What's Next?

### Planned for v0.3.8+
- Hardware PWM wrapper (stable frequency control)
- UART/Serial communication
- Additional sensor examples
- Performance optimizations
- Versioned documentation website

### Long-term Roadmap (v0.4.0)
- Complete Arduino API parity
- Advanced interrupt handling
- DMA support for high-speed I/O
- Package manager integration (vcpkg, Conan)

See [docs/planning/TODO.md](../docs/planning/TODO.md) for complete roadmap.

---

## üôè Acknowledgments

Thanks to:
- The Arduino community for API inspiration
- libgpiod developers for excellent GPIO support
- All PiPinPP users and contributors
- Linux kernel SPI subsystem maintainers

---

## üìñ Additional Resources

- **Getting Started:** [docs/GETTING_STARTED.md](../docs/GETTING_STARTED.md)
- **API Reference:** [docs/API_REFERENCE.md](../docs/API_REFERENCE.md)
- **Troubleshooting:** [docs/TROUBLESHOOTING.md](../docs/TROUBLESHOOTING.md)
- **Examples:** [examples/](../examples/)
- **GitHub:** https://github.com/Barbatos6669/PiPinPP

---

**Full Changelog:** [CHANGELOG.md](../CHANGELOG.md)

**Questions or issues?** Open an issue on GitHub or check our [FAQ](../docs/FAQ.md)!

---

## üéì Learning Resources

### For Arduino Users
All examples now include README files with:
- Hardware wiring diagrams
- Expected vs actual GPIO behavior
- Troubleshooting for common issues
- Migration tips from Arduino

### For C++ Developers
- Thread-safe design patterns demonstrated
- RAII resource management examples
- Exception handling best practices
- Modern C++17 features in action

---

**Enjoy building with PiPinPP v0.3.7!** üöÄ
