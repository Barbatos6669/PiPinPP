name: Changelog Generator

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    # Skip on Dependabot branches to avoid permission issues
    if: github.actor != 'dependabot[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          git-message: 'chore: update CHANGELOG.md for {version}'
          git-user-name: 'github-actions[bot]'
          git-user-email: 'github-actions[bot]@users.noreply.github.com'
          version-file: './CMakeLists.txt'
          version-path: 'project(PiPinPP VERSION'
          preset: 'conventionalcommits'
          output-file: 'CHANGELOG.md'
          release-count: '0'  # Include all releases
          skip-on-empty: 'true'
          skip-git-pull: 'false'
          skip-commit: 'false'
          skip-tag: 'true'  # Don't create tags automatically
          skip-ci: 'true'  # Skip CI on changelog commits
          tag-prefix: 'v'

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.changelog.outputs.skipped == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changelog = `${{ steps.changelog.outputs.clean_changelog }}`;
            if (changelog && changelog.length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“ Changelog Preview\n\n${changelog}\n\n---\n*This changelog will be automatically updated when merged to main.*`
              });
            }
